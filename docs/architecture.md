# Nominal Architecture Overview

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NOMINAL SYSTEM                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   INPUT      â”‚       â”‚  PROCESSING  â”‚       â”‚   OUTPUT     â”‚
â”‚              â”‚       â”‚              â”‚       â”‚              â”‚
â”‚  PDF Files   â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚  Components  â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚  Organized   â”‚
â”‚  (Tax Forms) â”‚       â”‚              â”‚       â”‚  Files       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. NOMINAL READER (âœ… Complete)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Input: PDF File                                            â”‚
â”‚     â”‚                                                        â”‚
â”‚     â”œâ”€â–¶ Text Extraction (PyMuPDF)                           â”‚
â”‚     â”‚      â”‚                                                 â”‚
â”‚     â”‚      â”œâ”€ Text Found? â”€â–¶ Return Text                    â”‚
â”‚     â”‚      â”‚                                                 â”‚
â”‚     â”‚      â””â”€ Low/No Text? â”€â–¶ OCR (Tesseract)               â”‚
â”‚     â”‚                            â”‚                           â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                              â”‚
â”‚  Output: Text Content                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. NOMINAL PROCESSOR (âœ… Complete)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Input: Text Content + Rule Files                           â”‚
â”‚     â”‚                                                        â”‚
â”‚     â”œâ”€â–¶ Load Rules (RuleParser)                             â”‚
â”‚     â”‚      â”‚                                                 â”‚
â”‚     â”‚      â””â”€â–¶ Parse YAML â”€â–¶ Rule Objects                   â”‚
â”‚     â”‚                                                        â”‚
â”‚     â”œâ”€â–¶ Match Criteria (CriteriaEvaluator)                  â”‚
â”‚     â”‚      â”‚                                                 â”‚
â”‚     â”‚      â”œâ”€ Check: contains, regex, all, any              â”‚
â”‚     â”‚      â”‚                                                 â”‚
â”‚     â”‚      â””â”€ Match Found? â”€â”                                â”‚
â”‚     â”‚                       â”‚                                â”‚
â”‚     â”‚                       â”œâ”€ Yes â”€â–¶ Execute Actions       â”‚
â”‚     â”‚                       â”‚                                â”‚
â”‚     â”‚                       â””â”€ No â”€â–¶ Try Next Rule          â”‚
â”‚     â”‚                                                        â”‚
â”‚     â””â”€â–¶ Extract Variables (ActionExecutor)                  â”‚
â”‚            â”‚                                                 â”‚
â”‚            â””â”€â–¶ set, regex_extract, derive, extract          â”‚
â”‚                                                              â”‚
â”‚  Output: {form_name, variables}                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. NOMINAL ORCHESTRATOR (ğŸ”„ Planned)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Input: Directory of PDFs                                   â”‚
â”‚     â”‚                                                        â”‚
â”‚     â”œâ”€â–¶ For each file:                                      â”‚
â”‚     â”‚      â”‚                                                 â”‚
â”‚     â”‚      â”œâ”€â–¶ Read (Nominal Reader)                        â”‚
â”‚     â”‚      â”‚                                                 â”‚
â”‚     â”‚      â”œâ”€â–¶ Process (Nominal Processor)                  â”‚
â”‚     â”‚      â”‚                                                 â”‚
â”‚     â”‚      â”œâ”€â–¶ Generate Filename                            â”‚
â”‚     â”‚      â”‚      â”‚                                          â”‚
â”‚     â”‚      â”‚      â””â”€â–¶ Template: {FORM}_{NAME}_{SSN}        â”‚
â”‚     â”‚      â”‚                                                 â”‚
â”‚     â”‚      â””â”€â–¶ Copy/Rename to Output Directory              â”‚
â”‚     â”‚                                                        â”‚
â”‚     â””â”€â–¶ Error Handling & Logging                            â”‚
â”‚                                                              â”‚
â”‚  Output: Organized Files + Logs                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Input.pdf  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Nominal Reader  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼ (text content)
      â”‚
      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   â”‚ Rule Files   â”‚
      â”‚   â”‚  - w2.yaml   â”‚
      â”‚   â”‚  - 1099.yaml â”‚
      â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚          â”‚
      â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Nominal Processor    â”‚
â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Match Criteria â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚          â”‚
â”‚           â–¼          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Execute Actionsâ”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Extracted Variables   â”‚
â”‚                       â”‚
â”‚ {                     â”‚
â”‚   form_name: "W2"     â”‚
â”‚   FIRST_NAME: "John"  â”‚
â”‚   LAST_NAME: "Smith"  â”‚
â”‚   SSN: "XXX-XX-6789"  â”‚
â”‚   SSN_LAST_FOUR: "..."â”‚
â”‚ }                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Output: W2_Smith_6789.pdfâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Rule Processing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Document    â”‚
â”‚ Text        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ For Each Rule:   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Evaluate Criteria      â”‚
â”‚                        â”‚
â”‚  â”œâ”€ contains          â”‚
â”‚  â”‚   "w-2"?           â”‚
â”‚  â”‚   âœ“ Yes            â”‚
â”‚  â”‚                    â”‚
â”‚  â”œâ”€ regex             â”‚
â”‚  â”‚   \d{3}-\d{2}-\d{4}â”‚
â”‚  â”‚   âœ“ Match: capturedâ”‚
â”‚  â”‚                    â”‚
â”‚  â””â”€ any/all           â”‚
â”‚      âœ“ All Match      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ (match found)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Execute Actions        â”‚
â”‚                        â”‚
â”‚  1. set: FORM_NAME     â”‚
â”‚     FORM_NAME = "W2"   â”‚
â”‚                        â”‚
â”‚  2. regex_extract:     â”‚
â”‚     FIRST_NAME = "..."â”‚
â”‚                        â”‚
â”‚  3. derive:            â”‚
â”‚     SSN_LAST_FOUR = ...â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return Result          â”‚
â”‚ {form_name, variables} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Class Hierarchy

```
NominalReader
â”œâ”€ __init__(ocr_fallback, min_text_length)
â”œâ”€ read_pdf(file_path) â†’ str
â””â”€ _ocr_page(page) â†’ str

NominalProcessor
â”œâ”€ __init__(rules_dir)
â”œâ”€ load_rules(rules_dir)
â”œâ”€ load_rule(rule_path)
â”œâ”€ process_document(text) â†’ Dict
â””â”€ _try_match_rule(rule, text) â†’ Dict

RuleParser
â”œâ”€ parse_file(rule_path) â†’ Rule
â”œâ”€ parse_dict(data) â†’ Rule
â”œâ”€ _parse_criterion(data) â†’ Criterion
â””â”€ _parse_action(data) â†’ Action

CriteriaEvaluator
â”œâ”€ evaluate(criterion, text) â†’ bool
â”œâ”€ _evaluate_contains(criterion, text) â†’ bool
â””â”€ _evaluate_regex(criterion, text) â†’ bool

ActionExecutor
â”œâ”€ execute(action, captured_values)
â”œâ”€ _execute_set(action)
â”œâ”€ _execute_regex_extract(action)
â”œâ”€ _execute_derive(action)
â””â”€ _execute_extract(action)
```

## File Organization

```
nominal/
â”‚
â”œâ”€â”€ src/nominal/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ reader.py           â† Milestone 1 âœ…
â”‚   â””â”€â”€ processor.py        â† Milestone 2 âœ…
â”‚
â”œâ”€â”€ rules/                  â† Rule Definitions
â”‚   â”œâ”€â”€ w2.yaml
â”‚   â”œâ”€â”€ 1099-misc.yaml
â”‚   â””â”€â”€ README.md
â”‚
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ fixtures/           â† Sample PDFs
â”‚   â”‚   â”œâ”€â”€ Sample-W2.pdf
â”‚   â”‚   â””â”€â”€ Sample-1099-image.pdf
â”‚   â”‚
â”‚   â””â”€â”€ nominal/
â”‚       â”œâ”€â”€ test_reader.py
â”‚       â”œâ”€â”€ test_reader_integration.py
â”‚       â”œâ”€â”€ test_processor.py            â† 19 tests
â”‚       â””â”€â”€ test_processor_integration.py â† 5 tests
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ processor.md
â”‚   â””â”€â”€ milestone2_summary.md
â”‚
â”œâ”€â”€ example_processor.py
â”œâ”€â”€ PLAN.md
â””â”€â”€ README.md
```

## Technology Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Python 3.13+              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  Reader   â”‚   â”‚  Processor  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚               â”‚
      â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚ PyMuPDF   â”‚   â”‚  PyYAML   â”‚
â”‚ Tesseract â”‚   â”‚  re       â”‚
â”‚ Pillow    â”‚   â”‚ (stdlib)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Features by Milestone

### âœ… Milestone 1: Reader
- PDF text extraction
- OCR for image-based PDFs
- Configurable thresholds
- Error handling

### âœ… Milestone 2: Processor
- YAML-based DSL
- Pattern matching (contains, regex, all, any)
- Variable extraction (set, regex_extract, derive, extract)
- Batch processing
- First-match rule selection
- 29 tests, all passing

### ğŸ”„ Milestone 3: Orchestrator (Next)
- Directory scanning
- File renaming
- Error logging
- CLI interface
- Configuration management
