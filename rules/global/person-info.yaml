# Global Rule: Person Information Extraction
# This rule extracts common person information across all tax documents

rule_id: person-info
description: Extracts taxpayer/recipient personal information

variables:
  global:
    - FULL_NAME
    - FIRST_NAME
    - LAST_NAME
    - TIN_LAST_FOUR

# No criteria - applies to all documents (global extraction)
criteria:
  - type: regex
    pattern: '.'  # Match any document with content
    description: "Matches any non-empty document"

actions:
  # Extract full name from uppercase format (common in tax forms)
  # Matches person names (2-3 words with optional middle initial)
  # followed by either $ (payer names) or newline+address (recipient names)
  # Excludes organization names (UNIVERSITY, COMPANY, CORPORATION, etc.)
  - type: regex_extract
    variable: FULL_NAME
    from_text: true
    pattern: '\b((?!(?:UNIVERSITY|COMPANY|CORPORATION|INC|LLC|OF)\b)[A-Z][A-Z]+(?:\s+[A-Z]\.?)?(?:\s+[A-Z][A-Z]+))(?=\s+\$|\s*\n\s*\d{3,})'
    group: 1
    required: false

  # Extract first name (mixed case format)
  - type: regex_extract
    variable: FIRST_NAME
    from_text: true
    pattern: '(?i)(?:employee|recipient|taxpayer).*?name.*?:\s*([A-Z][a-z]+)'
    group: 1
    required: false

  # Extract last name (mixed case format)
  - type: regex_extract
    variable: LAST_NAME
    from_text: true
    pattern: '(?i)(?:employee|recipient|taxpayer).*?name.*?:\s*[A-Z][a-z]+\s+([A-Z][a-z]+)'
    group: 1
    required: false

  # Extract TIN_LAST_FOUR from full SSN pattern (XXX-XX-XXXX)
  - type: regex_extract
    variable: TIN_LAST_FOUR
    from_text: true
    pattern: '\b\d{3}-\d{2}-(\d{4})\b'
    group: 1
    required: false

  # Extract TIN_LAST_FOUR from masked SSN (XXX-XX-1234)
  - type: regex_extract
    variable: TIN_LAST_FOUR
    from_text: true
    pattern: '(?:[X*]{3}-[X*]{2}-)(\d{4})\b'
    group: 1
    required: false

  # Extract TIN_LAST_FOUR directly if only last 4 digits shown
  - type: regex_extract
    variable: TIN_LAST_FOUR
    from_text: true
    pattern: '(?i)(?:SSN|TIN|Social\s+Security).*?(\d{4})(?!\d)'
    group: 1
    required: false
